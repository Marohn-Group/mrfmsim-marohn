!Experiment
name: CornellTDESRMultiPulsesStepped
version: 2022.11.10
graph:
    !Graph
    name: cornell_esr_graph
    grouped_edges:
        - [extended ogrid, extended sample ogrid]
        - [extended sample ogrid, extended Bz]
        - [sample ogrid, trapz field gradient]
        - [extended sample ogrid, extended Bzx]
        - [extended Bz, extended B total]
        - [extended B total, [extended B offset, B total]]
        - [B total, equilibrium magnetization per spin]
        - [[extended B offset, extended Bzx], relative polarization change]
        - [relative polarization change, averaged relative polarization change]
        - [[equilibrium magnetization per spin, trapz field gradient, averaged relative polarization change], signal]
    node_objects:
        extended ogrid:
            func: !Func mrfmsim.ancillary.execute
            inputs: [extend_grid_method, ext_pts]
            output: ext_ogrid
        extended sample ogrid:
            func: !Func mrfmsim_marohn.formulas.ogrid_sub
            inputs: [ext_ogrid, h]
            output: ext_sample_ogrid
        extended Bz:
            func: !Func mrfmsim.ancillary.execute
            inputs: [Bz_method, ext_sample_ogrid]
            output: ext_Bz
        extended B total:
            func: !Func operator.add
            inputs: [ext_Bz, B0]
            output: ext_B_tot
        B total:
            func: !Func mrfmsim_marohn.formulas.slice_matrix
            inputs: [ext_B_tot, grid_shape]
            output: B_tot
        sample ogrid:
            func: !Func mrfmsim_marohn.formulas.ogrid_sub
            inputs: [grid_array, h]
            output: sample_ogrid
        extended Bzx:
            func: !Func mrfmsim_marohn.formulas.ogrid_method
            inputs: [Bzx_method, ext_sample_ogrid]
            output: ext_Bzx
        trapz field gradient:
            func: !Func mrfmsim_marohn.formulas.xtrapz_field_gradient
            output: trapz_Bzxx
        equilibrium magnetization per spin:
            func: !Func mrfmsim_marohn.formulas.mz_eq
            output: mz_eq
        extended B offset:
            func: !Func mrfmsim_marohn.formulas.B_offset
            inputs: [ext_B_tot, f_rf, Gamma]
            output: ext_B_offset    
        relative polarization change:
            func: !Func mrfmsim_marohn.formulas.rel_dpol_sat_td_smallsteps
            output: rel_dpol
        averaged relative polarization change:
            func: !Func mrfmsim_marohn.formulas.rel_dpol_multipulse
            output: rel_dpol_avg
        signal:
            func: !Func mrfmsim_marohn.formulas.hex_mul_sum
            inputs: [trapz_Bzxx, rel_dpol_avg, mz_eq, spin_density, grid_voxel]
            output: dk_spin

component_substitutes:
    magnet: [Bz_method, Bzx_method]
    sample: [J, Gamma, spin_density, temperature, T1, T2]
    grid: [grid_array, grid_shape, grid_voxel, extend_grid_method]

description: Simulates a Cornell-style frequency shift magnetic resonance force
    microscope experiment considering the time dependent nature of the saturation,
    averaged over multiple pulses and with small step approximation. The function
    is modified for small tip, where the field calculation uses trapezoidal integral. 
