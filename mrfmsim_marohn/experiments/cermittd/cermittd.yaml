!experiment
name: CermitTimeDependent
version: 2022.11.18
description: Simulates a Cornell-style frequency shift magnetic resonance force
    microscope experiment considering the time dependent nature of the saturation,
    averaged over multiple pulses.
graph:
    !graph
    name: cornell_td_graph
    grouped_edges:
        - [convert microwave x_0p, [extended ogrid, relative polarization change]]
        - [extended ogrid, extended sample ogrid]
        - [extended sample ogrid, extended Bz]
        - [sample ogrid, Bzxx]
        - [sample ogrid, Bzx]
        - [extended Bz, extended B total]
        - [extended B total, [B total, extended B offset]]
        - [B total, equilibrium magnetization per spin]
        - [[extended B offset, Bzx], relative polarization change]
        - [relative polarization change, averaged relative polarization change]
        - [[equilibrium magnetization per spin, Bzxx, averaged relative polarization change], spring constant shift]
        - [spring constant shift, frequency shift]
    node_objects:
        convert microwave x_0p:
            func: !import mrfmsim_marohn.formulas.convert_grid_pts
            inputs: [mw_x_0p, grid_step]
            output: ext_pts
        extended ogrid:
            func: !func "lambda extend_grid_method, ext_pts: extend_grid_method(ext_pts)"
            inputs: [extend_grid_method, ext_pts]
            output: ext_ogrid
        extended sample ogrid:
            func: !import mrfmsim_marohn.formulas.ogrid_sub
            inputs: [ext_ogrid, h]
            output: ext_sample_ogrid
        extended Bz:
            func: !import mrfmsim_marohn.formulas.ogrid_method
            inputs: [Bz_method, ext_sample_ogrid]
            output: ext_Bz
        extended B total:
            func: !import operator.add
            inputs: [ext_Bz, B0]
            output: ext_B_tot
        B total:
            func: !import mrfmsim_marohn.formulas.slice_matrix
            inputs: [ext_B_tot, grid_shape]
            output: B_tot
        sample ogrid:
            func: !import mrfmsim_marohn.formulas.ogrid_sub
            inputs: [grid_array, h]
            output: sample_ogrid
        Bzx:
            func: !import mrfmsim_marohn.formulas.ogrid_method
            inputs: [Bzx_method, sample_ogrid]
            output: Bzx
        Bzxx:
            func: !import mrfmsim_marohn.formulas.ogrid_method
            inputs: [Bzxx_method, sample_ogrid]
            output: Bzxx
        equilibrium magnetization per spin:
            func: !import mrfmsim_marohn.formulas.mz_eq
            output: mz_eq
        extended B offset:
            func: !import mrfmsim_marohn.formulas.B_offset
            inputs: [ext_B_tot, f_rf, Gamma]
            output: ext_B_offset    
        relative polarization change:
            func: !import mrfmsim_marohn.formulas.rel_dpol_sat_td
            output: rel_dpol
        averaged relative polarization change:
            func: !import mrfmsim_marohn.formulas.rel_dpol_multipulse
            output: rel_dpol_avg
        spring constant shift:
            func: !import mrfmsim_marohn.formulas.sum_of_multiplication
            inputs: [Bzxx, rel_dpol_avg, mz_eq, spin_density, grid_voxel, [sign, -1]]
            output: dk_spin
        frequency shift:
            func: !import mrfmsim.ancillary.execute
            inputs: [dk_to_df_ac_cermit, dk_spin]
            output: df_spin

component_substitutes:
    magnet: [Bz_method, Bzx_method, Bzxx_method]
    sample: [J, Gamma, spin_density, temperature, T1, T2]
    grid: [grid_array, grid_shape, grid_step, grid_voxel, extend_grid_method]
    cantilever: [dk_to_df_ac_cermit]
