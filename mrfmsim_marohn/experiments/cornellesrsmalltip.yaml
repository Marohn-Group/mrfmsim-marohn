!Experiment
name: CornellESRSmallTip
version: 2022.11.10
graph:
    !Graph
    name: cornell_esr_graph
    grouped_edges:
        - [extended ogrid, extended sample ogrid]
        - [extended sample ogrid, extended Bz]
        - [sample ogrid, trapz field gradient]
        - [extended Bz, extended B total]
        - [extended B total, [extended B offset, B total]]
        - [B total, equilibrium magnetization per spin]
        - [extended B offset, minimum absolute x offset]
        - [minimum absolute x offset, relative polarization change]
        - [[equilibrium magnetization per spin, trapz field gradient, relative polarization change], signal]
    node_objects:
        extended ogrid:
            func: !Func mrfmsim.ancillary.execute
            inputs: [extend_grid_method, ext_pts]
            output: ext_ogrid
        extended sample ogrid:
            func: !Func mrfmsim_marohn.formulas.ogrid_sub
            inputs: [ext_ogrid, h]
            output: ext_sample_ogrid
        sample ogrid:
            func: !Func mrfmsim_marohn.formulas.ogrid_sub
            inputs: [grid_array, h]
            output: sample_ogrid
        extended Bz:
            func: !Func mrfmsim.ancillary.execute
            inputs: [Bz_method, ext_sample_ogrid]
            output: ext_Bz
        extended B total:
            func: !Func operator.add
            inputs: [ext_Bz, B0]
            output: ext_B_tot
        B total:
            func: !Func mrfmsim_marohn.formulas.slice_matrix
            inputs: [ext_B_tot, grid_shape]
            output: B_tot
        trapz field gradient:
            func: !Func mrfmsim_marohn.formulas.xtrapz_field_gradient
            output: trapz_Bzxx
        equilibrium magnetization per spin:
            func: !Func mrfmsim_marohn.formulas.mz_eq
            output: mz_eq
        extended B offset:
            func: !Func mrfmsim_marohn.formulas.B_offset
            inputs: [ext_B_tot, f_rf, Gamma]
            output: ext_B_offset    
        minimum absolute x offset:
            func: !Func mrfmsim_marohn.formulas.min_abs_x
            inputs: [ext_B_offset, ext_pts]
            output: B_offset
        relative polarization change:
            func: !Func mrfmsim_marohn.formulas.rel_dpol_sat_steadystate
            output: rel_dpol
        signal:
            func: !Func mrfmsim_marohn.formulas.hex_mul_sum
            inputs: [trapz_Bzxx, rel_dpol, mz_eq, spin_density, grid_voxel]
            output: dk_spin

component_substitutes:
    magnet: [Bz_method, Bzx_method]
    sample: [J, Gamma, spin_density, temperature, dB_sat, dB_hom]
    grid: [grid_step, grid_shape, grid_voxel, extend_grid_method]

description: Simulates a Cornell-style frequency shift magnetic resonance force
    microscope experiment in which microwaves are applied for half a cantilever
    cyclic to saturate electron spin resonance in a bowl-shaped region swept
    out by the cantilever motion. The function is modified for small tip, where
    the field calculation uses trapezoidal integral. 
